from swr.cn-south-1.myhuaweicloud.com/krakenplug/builder:v1.0 as builder
WORKDIR /app
COPY ./thirdparty/go-eflib/go.mod ./thirdparty/go-eflib/
RUN cd ./thirdparty/go-eflib && go mod download
COPY ./common/go.mod ./common/go.sum ./common/
RUN cd ./common && go mod download
COPY ./deviceplugin/go.mod ./deviceplugin/go.sum ./deviceplugin/
RUN cd ./deviceplugin && go mod download
COPY ./ ./

RUN make deviceplugin_build binary_dir="/app/bin"

FROM ubuntu:20.04
WORKDIR /app
COPY --from=builder /app/bin/deviceplugin /app/deviceplugin
COPY --from=builder /app/build/script/copy_lib.sh /app/copy_lib.sh
COPY --from=builder /app/build/application/deviceplugin/start.sh /app/start.sh

RUN chmod +x /app/deviceplugin /app/copy_lib.sh /app/start.sh

ENTRYPOINT ["/app/start.sh"]